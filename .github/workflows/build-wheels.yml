name: Build Wheels

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel==2.16.6

      - name: Build wheels (manylinux)
        env:
          CIBW_PLATFORM: linux
          CIBW_BEFORE_BUILD_LINUX: bash tools/before_build_linux.sh
          CIBW_ENVIRONMENT_LINUX: PATH=/opt/go/bin:$PATH
          CIBW_BUILD: cp38-manylinux_x86_64 cp39-manylinux_x86_64 cp310-manylinux_x86_64 cp311-manylinux_x86_64 cp312-manylinux_x86_64
          CIBW_TEST_COMMAND_LINUX: python -c "import python_manta; print('import success')"
          MANTA_REF: main
        run: |
          python -m cibuildwheel --output-dir dist

      - name: Smoke test built wheel
        run: |
          python -m venv wheel_venv
          wheel_venv/bin/pip install --upgrade pip
          wheel_venv/bin/pip install dist/python_manta-*.whl
          wheel_venv/bin/python -c "from python_manta import parse_demo_header; print('wheel import ok')"

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-manta-wheels
          path: dist/*.whl
