name: Build Wheels

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

jobs:
  # Determine version type for PEP 440 versions:
  # - Final release: v1.5.0 â†’ publish to PyPI
  # - Dev release: v1.5.0.dev0 â†’ publish to TestPyPI
  # - Pre-release: v1.5.0a0, v1.5.0b0, v1.5.0rc0 â†’ publish to TestPyPI
  check-version:
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      is_prerelease: ${{ steps.check.outputs.is_prerelease }}
      base_version: ${{ steps.check.outputs.base_version }}
      full_version: ${{ steps.check.outputs.full_version }}
      go_wrapper_changed: ${{ steps.check-go-wrapper.outputs.changed }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare tags

      - name: Check version type
        id: check
        run: |
          REF="${{ github.ref }}"
          # Final release: v1.5.0 or v1.4.5.2 (no suffix)
          if [[ "$REF" =~ ^refs/tags/v([0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?)$ ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "base_version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "full_version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Final release: ${BASH_REMATCH[1]}"
          # Dev release: v1.5.0.dev0, v1.4.5.2.dev7, etc (PEP 440)
          elif [[ "$REF" =~ ^refs/tags/v([0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?)\.(dev[0-9]+)$ ]]; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "base_version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "full_version=${BASH_REMATCH[1]}.${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Dev release: ${BASH_REMATCH[1]}.${BASH_REMATCH[3]}"
          # Pre-release: v1.5.0a0, v1.5.0b0, v1.5.0rc0 (PEP 440)
          elif [[ "$REF" =~ ^refs/tags/v([0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?)(a|b|rc)([0-9]+)$ ]]; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "base_version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "full_version=${BASH_REMATCH[1]}${BASH_REMATCH[3]}${BASH_REMATCH[4]}" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Pre-release: ${BASH_REMATCH[1]}${BASH_REMATCH[3]}${BASH_REMATCH[4]}"
          else
            # Not a version tag (branch push, PR, etc.)
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "base_version=" >> $GITHUB_OUTPUT
            echo "full_version=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Not a version tag: $REF"
          fi

      - name: Check if go_wrapper changed since base version
        id: check-go-wrapper
        run: |
          BASE_VERSION="${{ steps.check.outputs.base_version }}"
          IS_PRERELEASE="${{ steps.check.outputs.is_prerelease }}"

          if [[ "$IS_PRERELEASE" == "true" && -n "$BASE_VERSION" ]]; then
            # Check if go_wrapper/ changed since base version tag
            BASE_TAG="v${BASE_VERSION}"
            if git rev-parse "$BASE_TAG" >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only "$BASE_TAG"..HEAD -- go_wrapper/ || echo "")
              if [[ -n "$CHANGED_FILES" ]]; then
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "ðŸ”¨ go_wrapper/ changed since $BASE_TAG - rebuild required:"
                echo "$CHANGED_FILES"
              else
                echo "changed=false" >> $GITHUB_OUTPUT
                echo "âœ… go_wrapper/ unchanged since $BASE_TAG - can reversion wheels"
              fi
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ Base tag $BASE_TAG not found - will rebuild to be safe"
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Not a prerelease version, skipping go_wrapper check"
          fi

  # Build wheels from scratch (for releases, non-tag builds, or when go_wrapper changed)
  linux-wheels:
    needs: check-version
    if: needs.check-version.outputs.is_prerelease != 'true' || needs.check-version.outputs.go_wrapper_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Read manta version
        id: manta-version
        run: |
          MANTA_REF=$(grep -v '^#' .manta-version | grep -v '^[[:space:]]*$' | tail -n1 | tr -d '[:space:]')
          echo "MANTA_REF=${MANTA_REF}" >> $GITHUB_ENV
          echo "Locked manta version: ${MANTA_REF}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel

      - name: Build wheels (manylinux)
        env:
          CIBW_PLATFORM: linux
          CIBW_BEFORE_BUILD_LINUX: bash tools/before_build_linux.sh
          CIBW_ENVIRONMENT_LINUX: PATH=/opt/go/bin:$PATH MANTA_REF=${{ env.MANTA_REF }}
          CIBW_BUILD: cp38-manylinux_x86_64 cp39-manylinux_x86_64 cp310-manylinux_x86_64 cp311-manylinux_x86_64 cp312-manylinux_x86_64 cp313-manylinux_x86_64
          CIBW_TEST_COMMAND_LINUX: python -c "import python_manta; print('import success')"
        run: |
          python -m cibuildwheel --output-dir dist

      - name: Smoke test built wheel
        run: |
          python -m venv wheel_venv
          wheel_venv/bin/pip install --upgrade pip
          wheel_venv/bin/pip install pydantic
          wheel_venv/bin/pip install --no-index --find-links=./dist python-manta
          wheel_venv/bin/python -c "from python_manta import Parser; print('wheel import ok')"

      - name: Cache replay files
        uses: actions/cache@v4
        with:
          path: replays
          key: replays-v1-${{ hashFiles('tests/replay_cache.py') }}
          restore-keys: |
            replays-v1-

      - name: Download replays if not cached
        run: |
          mkdir -p replays
          for match_id in 8447659831 8461956309; do
            if [ ! -f "replays/${match_id}.dem" ]; then
              echo "Downloading replay ${match_id}..."
              curl -sL "https://storage.googleapis.com/dota-replays/${match_id}.dem" -o "replays/${match_id}.dem"
            else
              echo "Replay ${match_id} already cached"
            fi
          done
          ls -lh replays/

      - name: Run all tests
        env:
          DOTA_REPLAY_CACHE: ${{ github.workspace }}/replays
        run: |
          python -m venv test_venv
          test_venv/bin/pip install --upgrade pip
          test_venv/bin/pip install pydantic pytest pytest-cov
          test_venv/bin/pip install --no-index --find-links=./dist python-manta
          test_venv/bin/python -m pytest tests/python_manta/ -v --no-cov

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: dist/*.whl

  macos-wheels:
    needs: check-version
    if: needs.check-version.outputs.is_prerelease != 'true' || needs.check-version.outputs.go_wrapper_changed == 'true'
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Read manta version
        id: manta-version
        run: |
          MANTA_REF=$(grep -v '^#' .manta-version | grep -v '^[[:space:]]*$' | tail -n1 | tr -d '[:space:]')
          echo "MANTA_REF=${MANTA_REF}" >> $GITHUB_ENV
          echo "Locked manta version: ${MANTA_REF}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel

      - name: Build wheels (macOS)
        env:
          CIBW_PLATFORM: macos
          CIBW_BEFORE_BUILD_MACOS: bash tools/before_build_macos.sh
          CIBW_ENVIRONMENT_MACOS: MANTA_REF=${{ env.MANTA_REF }}
          CIBW_ARCHS_MACOS: ${{ matrix.arch }}
          CIBW_BUILD: cp38-macosx_${{ matrix.arch }} cp39-macosx_${{ matrix.arch }} cp310-macosx_${{ matrix.arch }} cp311-macosx_${{ matrix.arch }} cp312-macosx_${{ matrix.arch }} cp313-macosx_${{ matrix.arch }}
          CIBW_TEST_COMMAND_MACOS: python -c "import python_manta; print('import success')"
        run: |
          python -m cibuildwheel --output-dir dist

      - name: Debug - List built wheels
        if: matrix.arch == 'x86_64' || runner.arch == 'ARM64'
        run: |
          echo "=== Contents of dist/ folder ==="
          ls -lah dist/ || echo "âŒ dist/ folder is empty or doesn't exist"
          echo ""
          echo "=== Wheel files ==="
          ls -1 dist/*.whl 2>/dev/null || echo "âŒ No .whl files found"
          echo ""
          echo "Wheel count: $(ls -1 dist/*.whl 2>/dev/null | wc -l)"

      - name: Smoke test built wheel
        if: matrix.arch == 'arm64'
        run: |
          echo "=== Pre-install debugging ==="
          pwd
          ls -la dist/
          python --version
          echo ""
          python -m venv wheel_venv
          wheel_venv/bin/python -m pip install --upgrade pip
          wheel_venv/bin/pip install pydantic
          echo "=== Attempting install ==="
          wheel_venv/bin/pip install --no-index --find-links=./dist python-manta --verbose
          wheel_venv/bin/python -c "from python_manta import Parser; print('wheel import ok')"

      - name: Cache replay files
        if: matrix.arch == 'arm64'
        uses: actions/cache@v4
        with:
          path: replays
          key: replays-v1-${{ hashFiles('tests/replay_cache.py') }}
          restore-keys: |
            replays-v1-

      - name: Download replays if not cached
        if: matrix.arch == 'arm64'
        run: |
          mkdir -p replays
          for match_id in 8447659831 8461956309; do
            if [ ! -f "replays/${match_id}.dem" ]; then
              echo "Downloading replay ${match_id}..."
              curl -sL "https://storage.googleapis.com/dota-replays/${match_id}.dem" -o "replays/${match_id}.dem"
            else
              echo "Replay ${match_id} already cached"
            fi
          done
          ls -lh replays/

      - name: Run all tests
        if: matrix.arch == 'arm64'
        env:
          DOTA_REPLAY_CACHE: ${{ github.workspace }}/replays
        run: |
          python -m venv test_venv
          test_venv/bin/pip install --upgrade pip
          test_venv/bin/pip install pydantic pytest pytest-cov
          test_venv/bin/pip install --no-index --find-links=./dist python-manta
          test_venv/bin/python -m pytest tests/python_manta/ -v --no-cov

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.arch }}
          path: dist/*.whl

  windows-wheels:
    needs: check-version
    if: needs.check-version.outputs.is_prerelease != 'true' || needs.check-version.outputs.go_wrapper_changed == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Read manta version
        id: manta-version
        shell: bash
        run: |
          MANTA_REF=$(grep -v '^#' .manta-version | grep -v '^[[:space:]]*$' | tail -n1 | tr -d '[:space:]')
          echo "MANTA_REF=${MANTA_REF}" >> $GITHUB_ENV
          echo "Locked manta version: ${MANTA_REF}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel

      - name: Build wheels (Windows)
        env:
          CIBW_PLATFORM: windows
          CIBW_BEFORE_BUILD_WINDOWS: bash tools/before_build_windows.sh
          CIBW_ENVIRONMENT_WINDOWS: MANTA_REF=${{ env.MANTA_REF }}
          CIBW_BUILD: cp38-win_amd64 cp39-win_amd64 cp310-win_amd64 cp311-win_amd64 cp312-win_amd64 cp313-win_amd64
          CIBW_TEST_COMMAND_WINDOWS: python -c "import python_manta; print('import success')"
        run: |
          python -m cibuildwheel --output-dir dist

      - name: Smoke test built wheel
        shell: bash
        run: |
          python -m venv wheel_venv
          wheel_venv/Scripts/python -m pip install --upgrade pip
          wheel_venv/Scripts/pip install pydantic
          wheel_venv/Scripts/pip install --no-index --find-links=./dist python-manta
          wheel_venv/Scripts/python -c "from python_manta import Parser; print('wheel import ok')"

      - name: Cache replay files
        uses: actions/cache@v4
        with:
          path: replays
          key: replays-v1-${{ hashFiles('tests/replay_cache.py') }}
          restore-keys: |
            replays-v1-

      - name: Download replays if not cached
        shell: bash
        run: |
          mkdir -p replays
          for match_id in 8447659831 8461956309; do
            if [ ! -f "replays/${match_id}.dem" ]; then
              echo "Downloading replay ${match_id}..."
              curl -sL "https://storage.googleapis.com/dota-replays/${match_id}.dem" -o "replays/${match_id}.dem"
            else
              echo "Replay ${match_id} already cached"
            fi
          done
          ls -lh replays/

      - name: Run all tests
        shell: bash
        env:
          DOTA_REPLAY_CACHE: ${{ github.workspace }}/replays
        run: |
          python -m venv test_venv
          test_venv/Scripts/python -m pip install --upgrade pip
          test_venv/Scripts/pip install pydantic pytest pytest-cov
          test_venv/Scripts/pip install --no-index --find-links=./dist python-manta
          test_venv/Scripts/python -m pytest tests/python_manta/ -v --no-cov

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows
          path: dist/*.whl

  # Upload wheels to GitHub Release (for final releases only)
  upload-release:
    name: Upload to GitHub Release
    needs: [check-version, linux-wheels, macos-wheels, windows-wheels]
    if: needs.check-version.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List wheels
        run: |
          echo "ðŸ“¦ Wheels to upload to release:"
          ls -lh dist/
          echo "Total: $(ls -1 dist/*.whl | wc -l) wheels"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.whl
          tag_name: v${{ needs.check-version.outputs.full_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Reversion wheels for pre-releases (download from base release, re-version)
  # Only used when go_wrapper has NOT changed - otherwise we rebuild from scratch
  reversion-wheels:
    name: Re-version wheels for pre-release
    needs: check-version
    if: needs.check-version.outputs.is_prerelease == 'true' && needs.check-version.outputs.go_wrapper_changed != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download wheels from base release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_VERSION="${{ needs.check-version.outputs.base_version }}"
          echo "ðŸ“¥ Downloading wheels from release v${BASE_VERSION}..."
          mkdir -p base_wheels
          gh release download "v${BASE_VERSION}" --pattern "*.whl" --dir base_wheels
          echo "Downloaded wheels:"
          ls -lh base_wheels/

      - name: Re-version wheels
        run: |
          FULL_VERSION="${{ needs.check-version.outputs.full_version }}"
          # PEP 440 versions are already wheel-compatible
          echo "ðŸ”„ Re-versioning wheels to ${FULL_VERSION}..."
          mkdir -p dist
          for whl in base_wheels/*.whl; do
            echo "Processing: $whl"
            python tools/reversion_wheel.py "$whl" "$FULL_VERSION" --output-dir dist
          done
          echo ""
          echo "ðŸ“¦ Re-versioned wheels:"
          ls -lh dist/

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-reversioned
          path: dist/*.whl

  # Publish to TestPyPI (for dev/pre-release tags: .dev, a, b, rc)
  publish-test-pypi:
    name: Publish to TestPyPI
    needs: [check-version, linux-wheels, macos-wheels, windows-wheels, reversion-wheels]
    if: |
      always() &&
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/v') &&
      needs.check-version.outputs.is_prerelease == 'true' &&
      (needs.reversion-wheels.result == 'success' || (needs.linux-wheels.result == 'success' && needs.macos-wheels.result == 'success' && needs.windows-wheels.result == 'success'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Wheels to publish:"
          ls -lh dist/
          echo ""
          echo "Total wheels: $(ls -1 dist/*.whl | wc -l)"

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
          verbose: true
          skip-existing: true

  # Publish to PyPI (for final release tags: v1.5.0 with no suffix)
  publish-pypi:
    name: Publish to PyPI
    needs: [check-version, linux-wheels, macos-wheels, windows-wheels]
    if: |
      always() &&
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/v') &&
      needs.check-version.outputs.is_release == 'true' &&
      needs.linux-wheels.result == 'success' && needs.macos-wheels.result == 'success' && needs.windows-wheels.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    environment:
      name: pypi
      url: https://pypi.org/p/python-manta
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Wheels to publish:"
          ls -lh dist/
          echo ""
          echo "Total wheels: $(ls -1 dist/*.whl | wc -l)"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true
