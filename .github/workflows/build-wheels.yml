name: Build Wheels

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

jobs:
  linux-wheels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel

      - name: Build wheels (manylinux)
        env:
          CIBW_PLATFORM: linux
          CIBW_BEFORE_BUILD_LINUX: bash tools/before_build_linux.sh
          CIBW_ENVIRONMENT_LINUX: PATH=/opt/go/bin:$PATH
          CIBW_BUILD: cp38-manylinux_x86_64 cp39-manylinux_x86_64 cp310-manylinux_x86_64 cp311-manylinux_x86_64 cp312-manylinux_x86_64
          CIBW_TEST_COMMAND_LINUX: python -c "import python_manta; print('import success')"
          MANTA_REF: master
        run: |
          python -m cibuildwheel --output-dir dist

      - name: Smoke test built wheel
        run: |
          python -m venv wheel_venv
          wheel_venv/bin/pip install --upgrade pip
          wheel_venv/bin/pip install dist/python_manta-*.whl
          wheel_venv/bin/python -c "from python_manta import parse_demo_header; print('wheel import ok')"

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: dist/*.whl

  macos-wheels:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel

      - name: Build wheels (macOS)
        env:
          CIBW_PLATFORM: macos
          CIBW_BEFORE_BUILD_MACOS: bash tools/before_build_macos.sh
          CIBW_ARCHS_MACOS: ${{ matrix.arch }}
          CIBW_BUILD: cp38-macosx_${{ matrix.arch }} cp39-macosx_${{ matrix.arch }} cp310-macosx_${{ matrix.arch }} cp311-macosx_${{ matrix.arch }} cp312-macosx_${{ matrix.arch }}
          CIBW_TEST_COMMAND_MACOS: python -c "import python_manta; print('import success')"
          MANTA_REF: master
        run: |
          python -m cibuildwheel --output-dir dist

      - name: Smoke test built wheel
        if: matrix.arch == 'x86_64' || runner.arch == 'ARM64'
        run: |
          python -m venv wheel_venv
          wheel_venv/bin/pip install --upgrade pip
          wheel_venv/bin/pip install dist/python_manta-*.whl
          wheel_venv/bin/python -c "from python_manta import parse_demo_header; print('wheel import ok')"

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.arch }}
          path: dist/*.whl

  windows-wheels:
    runs-on: windows-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel

      - name: Build wheels (Windows)
        env:
          CIBW_PLATFORM: windows
          CIBW_BEFORE_BUILD_WINDOWS: bash tools/before_build_windows.sh
          CIBW_BUILD: cp38-win_amd64 cp39-win_amd64 cp310-win_amd64 cp311-win_amd64 cp312-win_amd64
          CIBW_TEST_COMMAND_WINDOWS: python -c "import python_manta; print('import success')"
          MANTA_REF: master
        run: |
          python -m cibuildwheel --output-dir dist

      - name: Smoke test built wheel
        shell: bash
        run: |
          python -m venv wheel_venv
          wheel_venv/Scripts/pip install --upgrade pip
          wheel_venv/Scripts/pip install dist/python_manta-*.whl
          wheel_venv/Scripts/python -c "from python_manta import parse_demo_header; print('wheel import ok')"

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows
          path: dist/*.whl

  publish-test-pypi:
    name: Publish to TestPyPI
    needs: [linux-wheels, macos-wheels, windows-wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-')
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Built wheels:"
          ls -lh dist/
          echo ""
          echo "Total wheels: $(ls -1 dist/*.whl | wc -l)"

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
          verbose: true
          skip-existing: true

  publish-pypi:
    name: Publish to PyPI
    needs: [linux-wheels, macos-wheels, windows-wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')
    environment:
      name: pypi
      url: https://pypi.org/p/python-manta
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Built wheels:"
          ls -lh dist/
          echo ""
          echo "Total wheels: $(ls -1 dist/*.whl | wc -l)"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist/
          verbose: true
