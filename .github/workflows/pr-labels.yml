name: PR Labeling

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Auto-label based on branch name
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml

      - name: Auto-label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          sync-labels: true

  check-version-bump:
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master'
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR version
        id: pr_version
        run: |
          PR_VERSION=$(grep "^version = " pyproject.toml | cut -d'"' -f2)
          echo "version=${PR_VERSION}" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Get base version
        id: base_version
        run: |
          BASE_VERSION=$(grep "^version = " pyproject.toml | cut -d'"' -f2)
          echo "version=${BASE_VERSION}" >> $GITHUB_OUTPUT

      - name: Check version changed
        run: |
          if [ "${{ steps.pr_version.outputs.version }}" != "${{ steps.base_version.outputs.version }}" ]; then
            echo "⚠️  Version changed from ${{ steps.base_version.outputs.version }} to ${{ steps.pr_version.outputs.version }}"
            echo ""
            echo "This is unusual for regular PRs. Version bumps should typically happen"
            echo "during release preparation, not in feature PRs."
            echo ""
            echo "If this is intentional, you can ignore this warning."
          else
            echo "✅ Version unchanged (as expected for regular PRs)"
          fi
